<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="Aplikacja fitness K.S-Gym">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="K.S-Gym">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icons/Icon-192.png">
  <link rel="apple-touch-icon" sizes="120x120" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <title>K.S-Gym</title>
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <!-- Audio element for iOS keepalive (silent audio to prevent app from being suspended) -->
  <audio id="keepalive-audio" loop playsinline style="display:none;">
    <source src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRwmHAAAAAAD/+9DEAAAIAANIAAAASVAAaQAAAATEFNRTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVX/+9DELwAADSAAAAAAAAANIAAAABVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVQ==" type="audio/mp3">
  </audio>
  
  <script>
    // Wykryj iOS
    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    
    console.log('ðŸ”” Platform detection - iOS:', isIOS, 'Safari:', isSafari);
    
    // Rejestracja Service Worker dla powiadomieÅ„ w tle
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js', { scope: '/' })
          .then(function(registration) {
            console.log('ðŸ”” Service Worker registered with scope:', registration.scope);
            window.swRegistration = registration;
            
            // NasÅ‚uchuj wiadomoÅ›ci od Service Worker
            navigator.serviceWorker.addEventListener('message', function(event) {
              console.log('ðŸ”” Message from SW:', event.data);
              if (event.data && event.data.type === 'NOTIFICATION_SHOWN') {
                // Powiadomienie zostaÅ‚o wyÅ›wietlone przez SW
                window.dispatchEvent(new CustomEvent('sw-notification-shown', { detail: event.data }));
              }
            });
          })
          .catch(function(error) {
            console.log('ðŸ”” Service Worker registration failed:', error);
          });
      });
    }
    
    // Funkcja do proÅ›by o uprawnienia do powiadomieÅ„ (musi byÄ‡ wywoÅ‚ana przy interakcji uÅ¼ytkownika!)
    window.requestNotificationPermission = function() {
      return new Promise(function(resolve) {
        if (!('Notification' in window)) {
          console.log('ðŸ”” Notifications not supported');
          resolve('not-supported');
          return;
        }
        
        if (Notification.permission === 'granted') {
          console.log('ðŸ”” Notifications already granted');
          resolve('granted');
          return;
        }
        
        if (Notification.permission === 'denied') {
          console.log('ðŸ”” Notifications denied');
          resolve('denied');
          return;
        }
        
        Notification.requestPermission().then(function(permission) {
          console.log('ðŸ”” Notification permission:', permission);
          resolve(permission);
        });
      });
    };
    
    // Funkcja do wysyÅ‚ania wiadomoÅ›ci do Service Worker
    window.sendToServiceWorker = function(message) {
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage(message);
        return true;
      } else if (window.swRegistration && window.swRegistration.active) {
        window.swRegistration.active.postMessage(message);
        return true;
      } else {
        console.log('ðŸ”” No active Service Worker controller');
        return false;
      }
    };
    
    // Funkcja do planowania powiadomienia przez Service Worker
    window.scheduleNotificationSW = function(id, title, body, delayMs) {
      console.log('ðŸ”” scheduleNotificationSW called:', id, title, delayMs);
      
      // Na iOS/Safari - uruchom audio keepalive Å¼eby zapobiec zamroÅ¼eniu
      if (isIOS) {
        startIOSKeepalive();
      }
      
      // Zapisz dane do localStorage jako backup
      try {
        var notifData = {
          id: id,
          title: title,
          body: body,
          scheduledAt: Date.now(),
          triggerAt: Date.now() + delayMs
        };
        localStorage.setItem('scheduled_notification', JSON.stringify(notifData));
      } catch(e) {
        console.log('ðŸ”” Error saving to localStorage:', e);
      }
      
      return window.sendToServiceWorker({
        type: 'SCHEDULE_NOTIFICATION',
        id: id,
        title: title,
        body: body,
        delayMs: delayMs
      });
    };
    
    // Funkcja do anulowania powiadomienia
    window.cancelNotificationSW = function(id) {
      console.log('ðŸ”” cancelNotificationSW called:', id);
      
      // Zatrzymaj iOS keepalive
      if (isIOS) {
        stopIOSKeepalive();
      }
      
      // WyczyÅ›Ä‡ localStorage
      try {
        localStorage.removeItem('scheduled_notification');
      } catch(e) {}
      
      return window.sendToServiceWorker({
        type: 'CANCEL_NOTIFICATION',
        id: id
      });
    };
    
    // iOS Keepalive - utrzymuje aplikacjÄ™ przy Å¼yciu poprzez ciche audio
    var iosKeepaliveInterval = null;
    
    function startIOSKeepalive() {
      if (!isIOS) return;
      
      console.log('ðŸ”” Starting iOS keepalive');
      var audio = document.getElementById('keepalive-audio');
      if (audio) {
        audio.play().catch(function(e) {
          console.log('ðŸ”” iOS keepalive audio play failed:', e);
        });
      }
      
      // Dodatkowo - ping Service Worker co 10 sekund
      if (!iosKeepaliveInterval) {
        iosKeepaliveInterval = setInterval(function() {
          window.sendToServiceWorker({ type: 'KEEPALIVE' });
        }, 10000);
      }
    }
    
    function stopIOSKeepalive() {
      if (!isIOS) return;
      
      console.log('ðŸ”” Stopping iOS keepalive');
      var audio = document.getElementById('keepalive-audio');
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
      
      if (iosKeepaliveInterval) {
        clearInterval(iosKeepaliveInterval);
        iosKeepaliveInterval = null;
      }
    }
    
    // Natychmiastowe wyÅ›wietlenie powiadomienia (fallback dla iOS)
    window.showNotificationNow = function(title, body) {
      console.log('ðŸ”” showNotificationNow called:', title);
      
      // Najpierw sprÃ³buj przez SW
      var sent = window.sendToServiceWorker({
        type: 'SHOW_NOTIFICATION_NOW',
        title: title,
        body: body
      });
      
      // Fallback - bezpoÅ›rednio przez Notification API
      if (!sent && 'Notification' in window && Notification.permission === 'granted') {
        try {
          new Notification(title, {
            body: body,
            icon: 'icons/Icon-192.png',
            tag: 'ks-gym-timer',
            requireInteraction: true
          });
        } catch(e) {
          console.log('ðŸ”” Direct notification failed:', e);
        }
      }
    };
    
    // SprawdÅº czy sÄ… zalegÅ‚e powiadomienia przy starcie
    window.addEventListener('load', function() {
      setTimeout(function() {
        try {
          var saved = localStorage.getItem('scheduled_notification');
          if (saved) {
            var data = JSON.parse(saved);
            if (data.triggerAt && Date.now() >= data.triggerAt) {
              console.log('ðŸ”” Found overdue notification, showing now');
              window.showNotificationNow(data.title, data.body);
              localStorage.removeItem('scheduled_notification');
            }
          }
        } catch(e) {
          console.log('ðŸ”” Error checking saved notification:', e);
        }
      }, 1000);
    });
  </script>
  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
